# https://docs.gitlab.com/ci/variables/
# https://gitlab-docs-d6a9bb.gitlab.io/ee/ci/variables/predefined_variables.html
# https://docs.gitlab.com/ci/yaml/

stages:
  - init
  - test
  - build
  - release

workflow:
  rules:
    # Run pipeline for merge requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    # Run pipeline for pushes to default branch
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    # Run pipeline for pushes to branches without open merge requests
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'
      when: never
    # Run pipeline for all other branch pushes
    - if: '$CI_COMMIT_BRANCH'
    # Run pipeline for web/api triggers
    - if: '$CI_PIPELINE_SOURCE == "web"'

variables:
  DOCKER_TLS_CERTDIR: ""
  DOCKER_REGISTRY: ${CI_REGISTRY}
  DOCKER_BUILDER_NAME: "builder-${CI_JOB_ID}"
  DOCKERHUB_PASSWORD: ${CI_REGISTRY_PASSWORD}
  DOCKERHUB_PASSWORD_READ: ${CI_REGISTRY_PASSWORD_READ}
  DOCKERHUB_REPOSITORY: kirbownz/electrolux-to-mqtt
  DOCKERHUB_USERNAME: ${CI_REGISTRY_USERNAME}
  README_FILEPATH: ${CI_PROJECT_DIR}/README.md
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  GIT_STRATEGY: clone
  GITLAB_TOKEN: ${CI_JOB_TOKEN}

# Default configuration for all jobs
default:
  # Prefer private runner (macos tag), fallback to shared runners if unavailable
  # Jobs without the macos tag will use shared runners automatically
  tags:
    - macos

################################################################### INIT STAGE JOBS ###################################################################

initialise variables:
  stage: init
  image: alpine:latest
  interruptible: true
  rules:
    - if: '$CI_COMMIT_TAG == null'
      changes:
        - .gitlab-ci.yml
        - docker-compose*.yml
        - Dockerfile
        - entrypoint.sh
        - package.json
        - pnpm-lock.yaml
        - src/**/*
        - tests/**/*
        - tsconfig.json
        - vitest.config.ts
        - vitest.setup.ts
      when: on_success
    - when: never
  cache: []
  artifacts:
    reports:
      dotenv: variables.env
  script:
    - touch variables.env
    - echo "NODE_VERSION=$(cat .nvmrc)-alpine3.23" >> variables.env

bump version:
  stage: init
  image:
    name: registry.gitlab.com/go-semantic-release/semantic-release:latest
    entrypoint: [""]
  interruptible: true
  rules:
    - if: '$CI_COMMIT_TAG == null'
      changes:
        - .gitlab-ci.yml
        - docker-compose*.yml
        - Dockerfile
        - entrypoint.sh
        - package.json
        - pnpm-lock.yaml
        - src/**/*
        - tests/**/*
        - tsconfig.json
        - vitest.config.ts
        - vitest.setup.ts
      when: on_success
    - when: never
  cache: []
  artifacts:
    paths:
      - .version-unreleased
      - build.env
      - UNRELEASED-CHANGELOG.md
      - sonar-project.properties
    expire_in: never
  before_script:
    - git config --global --add safe.directory "$CI_PROJECT_DIR"
    - git remote set-url origin "$CI_REPOSITORY_URL" || echo 'Not a git repository; skipping'
    - git fetch --tags --force || true
    - git fetch origin "$CI_DEFAULT_BRANCH" || true
  script:
    - semantic-release --version-file --allow-no-changes --changelog UNRELEASED-CHANGELOG.md --dry
    - export VERSION=$(cat .version-unreleased)
    - echo "VERSION=${VERSION}" > build.env
    - echo "sonar.projectVersion=${VERSION}" >> sonar-project.properties
    - cat UNRELEASED-CHANGELOG.md

install dependencies:
  stage: init
  image: node:${NODE_VERSION}
  interruptible: true
  rules:
    - if: '$CI_COMMIT_TAG == null'
      changes:
        - .gitlab-ci.yml
        - biome.jsonc
        - package.json
        - pnpm-lock.yaml
        - src/**/*
        - tests/**/*
        - tsconfig.json
        - vitest.config.ts
        - vitest.setup.ts
      when: on_success
    - when: never
  cache:
    key:
      prefix: ${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules
    policy: push
  needs:
    - job: initialise variables
      artifacts: true
  before_script:
    - corepack enable
    - corepack install
    - pnpm config set store-dir .pnpm-store
    - echo "Node version from .nvmrc:"
    - echo "$(cat .nvmrc)"
    - node --version
    - npm --version
    - pnpm --version
  script:
    - echo "Installing dependencies..."
    - pnpm install --config.scripts-prepend-node-path=true

################################################################### TEST STAGE JOBS ###################################################################

test:
  stage: test
  image: node:${NODE_VERSION}
  interruptible: true
  rules:
    - if: '$CI_COMMIT_TAG == null'
      changes:
        - .gitlab-ci.yml
        - biome.jsonc
        - package.json
        - pnpm-lock.yaml
        - src/**/*
        - tests/**/*
        - tsconfig.json
        - vitest.config.ts
        - vitest.setup.ts
      when: on_success
    - when: never
  cache:
    key:
      prefix: ${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules
    policy: pull
  needs:
    - job: initialise variables
      artifacts: true
    - job: install dependencies
      artifacts: false
  coverage: '/All files(?:\s*\x1b\[[0-9;]*m)?\s*\|(?:\s*\x1b\[[0-9;]*m)?\s*[0-9.]+(?:\s*\x1b\[[0-9;]*m)?\s*\|(?:\s*\x1b\[[0-9;]*m)?\s*[0-9.]+(?:\s*\x1b\[[0-9;]*m)?\s*\|(?:\s*\x1b\[[0-9;]*m)?\s*[0-9.]+(?:\s*\x1b\[[0-9;]*m)?\s*\|(?:\s*\x1b\[[0-9;]*m)?\s*([0-9.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week
  before_script:
    - echo "Running tests with coverage..."
    - corepack enable
    - corepack install
    - pnpm config set store-dir .pnpm-store
  script:
    - FORCE_COLOR=1 pnpm test
  allow_failure: false

lint:
  stage: test
  image: node:${NODE_VERSION}
  interruptible: true
  rules:
    - if: '$CI_COMMIT_TAG == null'
      changes:
        - .gitlab-ci.yml
        - biome.jsonc
        - package.json
        - pnpm-lock.yaml
        - src/**/*
        - tests/**/*
        - tsconfig.json
        - vitest.config.ts
        - vitest.setup.ts
      when: on_success
    - when: never
  cache:
    key:
      prefix: ${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules
    policy: pull
  needs:
    - job: initialise variables
      artifacts: true
    - job: install dependencies
      artifacts: false
  before_script:
    - echo "Running linter checks..."
    - corepack enable
    - corepack install
    - pnpm config set store-dir .pnpm-store
  script:
    - pnpm biome check .
  allow_failure: false

audit:
  stage: test
  image: node:${NODE_VERSION}
  interruptible: true
  rules:
    - if: '$CI_COMMIT_TAG == null'
      changes:
        - .gitlab-ci.yml
        - package.json
        - pnpm-lock.yaml
      when: on_success
    - when: never
  cache:
    key:
      prefix: ${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules
    policy: pull
  needs:
    - job: initialise variables
      artifacts: true
    - job: install dependencies
      artifacts: false
  before_script:
    - echo "Running security audit..."
    - corepack enable
    - corepack install
    - pnpm config set store-dir .pnpm-store
  script:
    - pnpm audit
  allow_failure: false

sonarcloud-check:
  stage: test
  rules:
    - if: '$CI_COMMIT_TAG == null'
      changes:
        - .gitlab-ci.yml
        - biome.jsonc
        - package.json
        - pnpm-lock.yaml
        - src/**/*
        - tests/**/*
        - tsconfig.json
        - vitest.config.ts
        - vitest.setup.ts
      when: on_success
    - when: never
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  cache:
    key:
      prefix: ${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}
      files:
        - pnpm-lock.yaml
    paths:
      - .sonar/cache
    policy: pull
  needs:
    - job: bump version
      artifacts: true
    - job: install dependencies
      artifacts: false
    - job: test
      artifacts: true
  before_script:
    - test -f coverage/lcov.info && echo "LCOV report found" || echo "LCOV report NOT found"
    - test -f coverage/cobertura-coverage.xml && echo "Cobertura report found" || echo "Cobertura report NOT found"
  script:
    - sonar-scanner

################################################################## BUILD STAGE JOBS ###################################################################

try to build docker images:
  stage: build
  image: docker:latest
  retry: 1
  interruptible: true
  rules:
    - if: '$CI_COMMIT_TAG == null && $CI_COMMIT_BRANCH != "main"'
      changes:
        - .gitlab-ci.yml
        - docker/Dockerfile
        - entrypoint.sh
        - package.json
        - pnpm-lock.yaml
        - src/**/*
        - tsconfig.json
      when: on_success
    - when: never
  cache: []
  variables:
    DOCKER_HOST: "unix:///var/run/docker.sock"  # Use local Docker for shell executor
  needs:
    - job: initialise variables
      artifacts: true
    - job: bump version
      artifacts: true
    - job: sonarcloud-check
      artifacts: false
  before_script:
    - export BUILDER_NAME="${DOCKER_BUILDER_NAME:-shared-ci-builder}"
    - docker buildx inspect "${BUILDER_NAME}" >/dev/null 2>&1 || docker buildx create --name "${BUILDER_NAME}" --driver docker-container --use
    - echo "${DOCKERHUB_PASSWORD_READ}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin "${DOCKER_REGISTRY}"
    - echo "${DOCKERHUB_PASSWORD_READ}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin dhi.io
  script:
    - source build.env
    - |
      docker buildx build \
        --builder "${BUILDER_NAME}" \
        --build-arg NODE_VERSION=${NODE_VERSION} \
        --build-arg VERSION=${VERSION} \
        --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
        --build-arg VCS_REF=${CI_COMMIT_SHORT_SHA} \
        --platform linux/amd64,linux/arm64 \
        -t kirbownz/electrolux-to-mqtt:latest \
        -f docker/Dockerfile .
  after_script:
    - docker buildx rm "${BUILDER_NAME}" || true

################################################################# RELEASE STAGE JOBS ##################################################################

generate changelog:
  image: kirbownz/combine-changelogs:latest
  stage: build
  interruptible: true
  allow_failure: false
  needs:
    - job: initialise variables
      artifacts: true
    - job: bump version
      artifacts: true
  artifacts:
    paths:
      - CHANGELOG.md
  script:
    - combine-changelogs -include UNRELEASED-CHANGELOG.md

build and deploy docker images:
  stage: release
  image: docker:latest
  retry: 1
  interruptible: true
  allow_failure: false
  rules:
    - if: '$CI_COMMIT_TAG == null && $CI_COMMIT_BRANCH == "main"'
      changes:
        - .gitlab-ci.yml
        - docker/Dockerfile
        - entrypoint.sh
        - package.json
        - pnpm-lock.yaml
        - src/**/*
        - tsconfig.json
      when: on_success
    - when: never
  cache: []
  variables:
    DOCKER_HOST: "unix:///var/run/docker.sock"  # Use local Docker for shell executor
  needs:
    - job: initialise variables
      artifacts: true
    - job: bump version
      artifacts: true
    - job: sonarcloud-check
      artifacts: false
    - job: generate changelog
      artifacts: true
  before_script:
    - export BUILDER_NAME="${DOCKER_BUILDER_NAME:-shared-ci-builder}"
    - docker buildx inspect "${BUILDER_NAME}" >/dev/null 2>&1 || docker buildx create --name "${BUILDER_NAME}" --driver docker-container --use
    - echo "${DOCKERHUB_PASSWORD}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin "${DOCKER_REGISTRY}"
    - echo "${DOCKERHUB_PASSWORD_READ}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin dhi.io
  script:
    - source build.env
    - |
      docker buildx build \
        --builder "${BUILDER_NAME}" \
        --build-arg NODE_VERSION=${NODE_VERSION} \
        --build-arg VERSION=${VERSION} \
        --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
        --build-arg VCS_REF=${CI_COMMIT_SHORT_SHA} \
        --push \
        --provenance=true \
        --sbom=true \
        --platform linux/amd64,linux/arm64 \
        -t ${DOCKER_REGISTRY}/${DOCKERHUB_REPOSITORY}:${VERSION} \
        -t ${DOCKER_REGISTRY}/${DOCKERHUB_REPOSITORY}:latest \
        -f docker/Dockerfile .
  after_script:
    - docker buildx rm "${BUILDER_NAME}" || true

create gitlab release:
  stage: release
  image:
    name: registry.gitlab.com/go-semantic-release/semantic-release:latest
    entrypoint: [""]
  interruptible: true
  rules:
    - if: '$CI_COMMIT_TAG == null && $CI_COMMIT_BRANCH == "main"'
      changes:
        - .gitlab-ci.yml
        - docker/Dockerfile
        - entrypoint.sh
        - package.json
        - pnpm-lock.yaml
        - src/**/*
        - tsconfig.json
      when: on_success
    - when: never
  cache: []
  needs:
    - job: initialise variables
      artifacts: false
    - job: bump version
      artifacts: true
    - job: build and deploy docker images
      artifacts: false
  before_script:
    - git config --global --add safe.directory "$CI_PROJECT_DIR"
    - git remote set-url origin "$CI_REPOSITORY_URL" || echo 'Not a git repository; skipping'
    - git fetch --tags --force || true
    - git fetch origin "$CI_DEFAULT_BRANCH" || true
  script:
    - semantic-release --allow-no-changes

update telemetry backend:
  stage: release
  image: alpine:latest
  rules:
    - if: '$CI_COMMIT_TAG == null && $CI_COMMIT_BRANCH == "main"'
      changes:
        - .gitlab-ci.yml
        - telemetry-backend/**/*
      when: on_success
    - when: never
  cache: []
  needs:
    - job: build and deploy docker images
      artifacts: false
      optional: true
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "${SSH_KEY}" | base64 -d > ~/.ssh/id_rsa
    - chmod 700 ~/.ssh
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -t rsa ${TELEMETRY_HOST} >> ~/.ssh/known_hosts
  script:
    - ssh ${TELEMETRY_USER}@${TELEMETRY_HOST} "cd ${TELEMETRY_PATH} && ./telemetry-backend/start.sh"

update dockerhub description:
  stage: release
  image: peterevans/dockerhub-description:4
  interruptible: true
  rules:
    - if: '$CI_COMMIT_TAG == null && $CI_COMMIT_BRANCH == "main"'
      when: on_success
    - when: never
  cache: []
  needs:
    - job: build and deploy docker images
      artifacts: false
      optional: true
  before_script:
    - echo "${DOCKERHUB_PASSWORD}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin "${DOCKER_REGISTRY}"
  script:
    - "--pipeline"
