#!/bin/sh

# Pre-commit hook to run format and lint on staged files only

# Get the repository root directory
REPO_ROOT=$(git rev-parse --show-toplevel)
BIOME="$REPO_ROOT/node_modules/.bin/biome"

# Source common functions
# shellcheck disable=SC1091
. "$REPO_ROOT/.githooks/common.sh"

# Setup node environment
if ! setup_node; then
  exit 1
fi

# Check if biome is installed
if [ ! -f "$BIOME" ]; then
  step_fail "Biome not found in node_modules. Run 'pnpm install' first."
fi

# Stash unstaged changes to avoid formatting/linting them
step_exec "Stashing unstaged changes..."
if git stash push --keep-index --include-untracked --message "pre-commit-stash" > /dev/null 2>&1; then
  STASH_RESULT=0
  step_done "Stashed unstaged changes"
else
  STASH_RESULT=1
  step_skip "No unstaged changes to stash"
fi

# Get list of staged files that Biome supports
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx|json|jsonc)$')

if [ -n "$STAGED_FILES" ]; then
  # Run format on staged files
  step_exec "Running format on staged files..."
  if echo "$STAGED_FILES" | xargs "$BIOME" format --write > /dev/null 2>&1; then
    step_done "Format completed"
  else
    step_fail "Format failed"
  fi
  
  # Run lint on staged files
  step_exec "Running lint on staged files..."
  if echo "$STAGED_FILES" | xargs "$BIOME" lint --write > /dev/null 2>&1; then
    step_done "Lint completed"
  else
    step_fail "Lint failed"
  fi
  
  # Add formatted/linted files back to staging
  step_exec "Adding formatted files to staging..."
  echo "$STAGED_FILES" | xargs git add
  step_done "Added formatted files to staging"
else
  step_skip "No Biome-supported files staged"
fi

# Pop stash to restore unstaged changes
if [ $STASH_RESULT -eq 0 ]; then
  step_exec "Restoring unstaged changes..."
  if git stash pop > /dev/null 2>&1; then
    step_done "Restored unstaged changes"
  else
    # Only warn if stash pop fails - don't fail the commit
    step_skip "No unstaged changes to restore (stash may be empty)"
  fi
fi

exit 0
